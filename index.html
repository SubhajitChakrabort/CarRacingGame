<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Race by Aanchal - Location Racing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'game-teal': '#008080',
                        'game-tomato': '#ff6347',
                        'game-green': '#22c55e',
                        'game-red': '#ef4444',
                        'location-blue': '#3b82f6'
                    },
                    animation: {
                        'fade-in': 'fadeIn 4s ease-out',
                        'slide-in-left': 'slideInLeft 4s ease-out',
                        'bounce-in': 'bounceIn 0.5s ease-out',
                        'pulse-fast': 'pulse 0.5s ease-in-out infinite',
                        'target-pulse': 'targetPulse 2s ease-in-out infinite'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes targetPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        .game-bg {
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("https://play-lh.googleusercontent.com/bLuGzhIS8yECZTAKsrOqfRcYxapgXBfnvHXO3rGT6w1CLxlRXTwE684s4f9NFMPM9X0") no-repeat center center;
            background-size: cover;
            background-attachment: fixed;
        }

        .UserCar {
            width: 50px;
            height: 100px;
            position: absolute;
            bottom: 200px;
            background-image: url(car1.png);
            background-size: cover;
            border: 3px solid #22c55e;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
        }

        /* Mobile responsive user car positioning */
        @media (max-width: 768px) {
            .UserCar {
                bottom: 180px;
                width: 45px;
                height: 90px;
            }
        }

        @media (max-width: 480px) {
            .UserCar {
                bottom: 160px;
                width: 40px;
                height: 80px;
            }
        }

        .lines {
            width: 10px;
            height: 100px;
            background: white;
            position: absolute;
            margin-left: 195px;
        }

        .other {
            width: 50px;
            height: 100px;
            position: absolute;
            bottom: 120px;
            background-size: cover;
            border: 2px solid #ef4444;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        /* Target area styling */
        .target-area {
            width: 60px;
            height: 30px;
            position: absolute;
            background: linear-gradient(45deg, #22c55e, #16a34a);
            border: 3px solid #15803d;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.8);
            animation: targetPulse 2s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Mobile responsive enemy cars */
        @media (max-width: 768px) {
            .other {
                width: 45px;
                height: 90px;
            }

            .target-area {
                width: 50px;
                height: 25px;
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .other {
                width: 40px;
                height: 80px;
            }

            .target-area {
                width: 45px;
                height: 20px;
                font-size: 8px;
            }
        }

        .backgroundLeft,
        .backgroundRight {
            background: white url("backgroundImage.gif") no-repeat scroll center;
            background-size: cover;
        }

        .countdown {
            font-size: 6rem;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .countdown {
                font-size: 4rem;
            }
        }

        .speed-indicator {
            transition: all 0.3s ease;
        }

        .collision-highlight {
            animation: pulse 0.5s ease-in-out 3;
            border-color: #ff0000 !important;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.8) !important;
        }

        .target-collected {
            animation: bounceIn 0.5s ease-out;
            background: linear-gradient(45deg, #fbbf24, #f59e0b) !important;
            border-color: #d97706 !important;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.9) !important;
        }

        /* Mobile navbar styles */
        .mobile-menu {
            transform: translateY(-100%);
            transition: transform 0.3s ease-in-out;
        }

        .mobile-menu.active {
            transform: translateY(0);
        }

        /* High Score Display - Updated for mobile */
        .high-score-display {
            position: fixed;
            top: 60px;
            right: 10px;
            z-index: 40;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            border: 2px solid #ff6347;
            font-size: 12px;
        }

        @media (min-width: 768px) {
            .high-score-display {
                top: 80px;
                right: 20px;
                font-size: 14px;
                padding: 6px 12px;
            }
        }

        /* Location display */
        .location-display {
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 40;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            border: 2px solid #3b82f6;
            font-size: 10px;
            max-width: 150px;
        }

        @media (min-width: 768px) {
            .location-display {
                top: 80px;
                left: 20px;
                font-size: 12px;
                padding: 6px 12px;
                max-width: 200px;
            }
        }

        /* Map container */
        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 768px) {
            .map-container {
                height: 400px;
            }
        }

        /* Ultra Compact Game UI Styles for Mobile */
        .game-ui-ultra-compact {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(3px);
            border-radius: 4px;
            padding: 3px 6px;
            margin: 1px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .game-ui-ultra-compact {
                padding: 6px 10px;
                font-size: 12px;
                margin: 2px;
                border-radius: 6px;
            }
        }

        @media (min-width: 1024px) {
            .game-ui-ultra-compact {
                padding: 8px 12px;
                font-size: 14px;
                border-radius: 8px;
            }
        }

        /* Speed indicator specific styles */
        .speed-indicator-ultra-compact {
            background: rgba(40, 40, 40, 0.9);
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        /* Target indicator styles */
        .target-indicator-ultra-compact {
            background: rgba(34, 197, 94, 0.9);
            color: white;
            border: 1px solid #22c55e;
        }

        /* Distance indicator styles */
        .distance-indicator-ultra-compact {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: 1px solid #3b82f6;
        }

        /* Control icons ultra compact - INCREASED SIZE */
        .control-icon-ultra-compact {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.5);
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        @media (min-width: 768px) {
            .control-icon-ultra-compact {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
        }

        @media (min-width: 1024px) {
            .control-icon-ultra-compact {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }

        /* Game area container - MINIMAL BLACK BACKGROUND */
        .game-area-container {
            background: transparent;
            min-height: auto;
            padding-top: 0;
        }

        /* Game UI bar - like navbar */
        .game-ui-bar {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            height: 50px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        @media (min-width: 768px) {
            .game-ui-bar {
                height: 60px;
            }
        }

        /* INCREASED GAME AREA SIZE */
        .GameArea {
            width: 320px !important;
            height: 500px !important;
        }

        @media (min-width: 768px) {
            .GameArea {
                width: 400px !important;
                height: 600px !important;
            }
        }

        @media (min-width: 1024px) {
            .GameArea {
                width: 480px !important;
                height: 700px !important;
            }
        }

        /* Compact mobile controls positioning - UPDATED FOR 2x2 GRID */
        .mobile-controls-compact {
            bottom: 20px;
            padding: 0;
        }

        .mobile-controls-compact .control-grid-2x2 {
            width: 160px;
            gap: 8px;
        }

        .mobile-controls-compact button {
            padding: 12px;
            font-size: 20px;
            border-radius: 8px;
            min-height: 50px;
            min-width: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 480px) {
            .mobile-controls-compact .control-grid-2x2 {
                width: 180px;
                gap: 10px;
            }

            .mobile-controls-compact button {
                padding: 14px;
                font-size: 22px;
                min-height: 55px;
                min-width: 80px;
            }
        }

        @media (min-width: 768px) {
            .mobile-controls-compact .control-grid-2x2 {
                width: 200px;
                gap: 12px;
            }

            .mobile-controls-compact button {
                padding: 16px;
                font-size: 24px;
                min-height: 60px;
                min-width: 90px;
            }
        }

        /* Game container - centered with minimal black */
        .game-container {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        @media (min-width: 768px) {
            .game-container {
                min-height: calc(100vh - 80px);
                padding: 20px;
            }
        }

        /* Location permission modal */
        .location-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 20px;
        }

        .location-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* Target reached animation */
        .target-reached-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.8);
            animation: bounceIn 0.8s ease-out;
        }

        @media (max-width: 768px) {
            .target-reached-animation {
                font-size: 16px;
                padding: 15px 25px;
            }
        }

        /* Route line on game area */
        .route-line {
            position: absolute;
            width: 4px;
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            border-radius: 2px;
            opacity: 0.6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* GPS status indicator */
        .gps-status {
            position: fixed;
            top: 100px;
            right: 10px;
            z-index: 40;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid;
        }

        .gps-status.active {
            border-color: #22c55e;
            color: #22c55e;
        }

        .gps-status.inactive {
            border-color: #ef4444;
            color: #ef4444;
        }

        @media (min-width: 768px) {
            .gps-status {
                top: 120px;
                right: 20px;
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>

<body class="font-sans bg-gray-100">
    <!-- High Score Display -->
    <div id="highScoreDisplay" class="high-score-display">
        High Score: <span id="topHighScore">0</span>
    </div>

    <!-- Location Display -->
    <div id="locationDisplay" class="location-display">
        <div id="locationText">üìç Getting location...</div>
    </div>

    <!-- GPS Status -->
    <div id="gpsStatus" class="gps-status inactive">
        GPS: OFF
    </div>

    <!-- Location Permission Modal -->
    <div id="locationModal" class="location-modal hidden">
        <div class="location-modal-content">
            <h2 class="text-2xl font-bold text-game-teal mb-4">üó∫Ô∏è Location Racing Mode</h2>
            <p class="text-gray-600 mb-6">
                This game uses your location to create real racing routes and target areas.
                Your location data is only used for gameplay and is not stored or shared.
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="requestLocationPermission()"
                    class="bg-game-green text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                    Enable Location
                </button>
                <button onclick="playWithoutLocation()"
                    class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                    Play Without Location
                </button>
            </div>
        </div>
    </div>

    <!-- Audio elements -->
    <audio id="backgroundMusic" src="backgroundMusic.wav" loop></audio>
    <audio id="collisionSound" src="collision_sound.mp3"></audio>
    <audio id="scoreSound" src="score_sound.mp3"></audio>
    <audio id="accelerationSound" src="acceleration_sound.mp3"></audio>
    <audio id="brakeSound" src="brake_sound.mp3"></audio>
    <audio id="countdownSound" src="countdown_sound.mp3"></audio>
    <audio id="targetReachedSound" src="target_reached.mp3"></audio>

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 bg-game-teal text-white z-50 shadow-lg">
        <div class="container mx-auto px-4">
            <!-- Desktop Navigation -->
            <div class="hidden md:flex justify-between items-center py-4">
                <h1 class="text-2xl font-bold">üèÅ Aanchal Location Race</h1>
                <div class="space-x-4">
                    <button onclick="showHome()"
                        class="bg-white text-game-teal px-4 py-2 rounded hover:bg-gray-100 transition-colors">Home</button>
                    <button onclick="showRules()"
                        class="bg-white text-game-teal px-4 py-2 rounded hover:bg-gray-100 transition-colors">Rules</button>
                    <button onclick="showLocationMap()"
                        class="bg-white text-game-teal px-4 py-2 rounded hover:bg-gray-100 transition-colors">Map</button>
                    <button onclick="showGame()"
                        class="bg-white text-game-teal px-4 py-2 rounded hover:bg-gray-100 transition-colors">Game</button>
                </div>
            </div>

            <!-- Mobile Navigation -->
            <div class="md:hidden">
                <div class="flex justify-between items-center py-3">
                    <h1 class="text-sm font-bold">üèÅ Location Race</h1>
                    <button onclick="toggleMobileMenu()" class="text-white focus:outline-none">
                        <svg id="hamburger" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        <svg id="close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Mobile Menu -->
                <div id="mobileMenu"
                    class="mobile-menu absolute top-full left-0 right-0 bg-game-teal border-t border-teal-600">
                    <div class="flex flex-col">
                        <div class="flex">
                            <button onclick="showHome(); toggleMobileMenu();"
                                class="flex-1 bg-white text-game-teal py-2 px-3 hover:bg-gray-100 transition-colors border-r border-gray-300 text-sm">Home</button>
                            <button onclick="showRules(); toggleMobileMenu();"
                                class="flex-1 bg-white text-game-teal py-2 px-3 hover:bg-gray-100 transition-colors text-sm">Rules</button>
                        </div>
                        <div class="flex">
                            <button onclick="showLocationMap(); toggleMobileMenu();"
                                class="flex-1 bg-white text-game-teal py-2 px-3 hover:bg-gray-100 transition-colors border-r border-gray-300 text-sm">Map</button>
                            <button onclick="showGame(); toggleMobileMenu();"
                                class="flex-1 bg-white text-game-teal py-2 px-3 hover:bg-gray-100 transition-colors text-sm">Game</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Screen -->
    <div id="homeScreen" class="min-h-screen game-bg flex flex-col justify-center items-center text-center px-4 pt-20">
        <h1 class="text-white text-2xl md:text-5xl lg:text-6xl font-bold mb-8 animate-fade-in shadow-2xl p-4 md:p-6 rounded-lg"
            style="box-shadow: 0 0 40px #ff6347;">
            üèÅ Welcome to Location Racing
        </h1>
        <p class="text-white text-sm md:text-xl mb-8 animate-slide-in-left bg-black bg-opacity-50 p-4 rounded-lg">
            Race through real locations and reach target areas!
        </p>
        <div class="flex flex-col sm:flex-row gap-4 md:gap-6">
            <button onclick="showLocationMap()"
                class="bg-transparent border-2 border-location-blue text-white px-4 py-2 md:px-8 md:py-4 rounded-lg text-sm md:text-xl font-semibold hover:bg-location-blue hover:text-white transition-all duration-300 transform hover:scale-105"
                style="box-shadow: 0 0 20px #3b82f6;">
                üó∫Ô∏è View Map
            </button>
            <button onclick="showGame()"
                class="bg-transparent border-2 border-game-teal text-white px-4 py-2 md:px-8 md:py-4 rounded-lg text-sm md:text-xl font-semibold hover:bg-game-teal hover:text-white transition-all duration-300 transform hover:scale-105"
                style="box-shadow: 0 0 20px #ff6347;">
                üöó Start Race
            </button>
            <button onclick="showRules()"
                class="bg-transparent border-2 border-game-green text-white px-4 py-2 md:px-8 md:py-4 rounded-lg text-sm md:text-xl font-semibold hover:bg-game-green hover:text-white transition-all duration-300 transform hover:scale-105"
                style="box-shadow: 0 0 20px #22c55e;">
                üìã Rules
            </button>
        </div>
    </div>

    <!-- Location Map Screen -->
    <div id="locationMapScreen" class="hidden min-h-screen bg-gray-100 pt-20 px-4">
        <div class="container mx-auto max-w-6xl">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h1 class="text-game-teal text-2xl md:text-3xl font-bold mb-4">üó∫Ô∏è Racing Map & Targets</h1>

                <!-- Map Container -->
                <div id="mapContainer" class="map-container mb-6"></div>

                <!-- Location Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">üìç Current Location</h3>
                        <div id="currentLocationInfo" class="text-sm text-gray-600">
                            Getting your location...
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">üéØ Target Areas</h3>
                        <div id="targetAreasInfo" class="text-sm text-gray-600">
                            <div class="mb-2">‚Ä¢ Target areas are generated around you</div>
                            <div class="mb-2">‚Ä¢ Reach targets to score points</div>
                            <div>‚Ä¢ Distance affects scoring multiplier</div>
                        </div>
                    </div>
                </div>

                <!-- Race Statistics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-game-teal text-white p-3 rounded-lg text-center">
                        <div class="text-lg font-bold" id="targetsReached">0</div>
                        <div class="text-xs">Targets Reached</div>
                    </div>
                    <div class="bg-location-blue text-white p-3 rounded-lg text-center">
                        <div class="text-lg font-bold" id="totalDistance">0m</div>
                        <div class="text-xs">Distance Traveled</div>
                    </div>
                    <div class="bg-game-green text-white p-3 rounded-lg text-center">
                        <div class="text-lg font-bold" id="currentTarget">-</div>
                        <div class="text-xs">Current Target</div>
                    </div>
                    <div class="bg-game-tomato text-white p-3 rounded-lg text-center">
                        <div class="text-lg font-bold" id="locationAccuracy">-</div>
                        <div class="text-xs">GPS Accuracy</div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="refreshLocation()"
                        class="bg-location-blue text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                        üîÑ Refresh Location
                    </button>
                    <button onclick="showGame()"
                        class="bg-game-green text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                        üöó Start Racing
                    </button>
                    <button onclick="showHome()"
                        class="bg-game-teal text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                        üè† Back to Home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rules Screen -->
    <div id="rulesScreen" class="hidden min-h-screen bg-gray-100 pt-20 px-4">
        <div class="container mx-auto max-w-6xl">
            <div class="flex flex-col lg:flex-row gap-6 md:gap-8">
                <!-- Game Image -->
                <div class="lg:w-1/2">
                    <img src="backgroundImageRule.png" alt="Location Racing Game" class="w-full rounded-lg shadow-lg">
                </div>

                <!-- Rules Content -->
                <div class="lg:w-1/2 bg-white rounded-lg shadow-lg p-6 md:p-8">
                    <h1 class="text-game-teal text-2xl md:text-3xl font-bold mb-4">üèÅ Location Racing Rules</h1>
                    <h2 class="text-xl md:text-2xl font-semibold mb-4">How to Play:</h2>

                    <ol class="space-y-4 text-sm md:text-base leading-relaxed">
                        <li><strong>üéØ Objective:</strong> Navigate your green car through traffic while reaching
                            real-world target locations to score points.</li>
                        <li><strong>üìç Location Setup:</strong> Allow location access to enable GPS-based racing. Target
                            areas are generated around your real location.</li>
                        <li><strong>üöó Controls:</strong>
                            <ul class="ml-4 mt-2 space-y-1">
                                <li>‚Ä¢ Arrow Keys: Move your car</li>
                                <li>‚Ä¢ Up Arrow: Accelerate (0-200 kmph)</li>
                                <li>‚Ä¢ Down Arrow: Brake (reduce speed)</li>
                                <li>‚Ä¢ Mobile: Use 2x2 touch controls</li>
                            </ul>
                        </li>
                        <li><strong>üéØ Target System:</strong>
                            <ul class="ml-4 mt-2 space-y-1">
                                <li>‚Ä¢ Green pulsing areas appear on the road</li>
                                <li>‚Ä¢ Drive through them to collect points</li>
                                <li>‚Ä¢ Closer targets = higher score multiplier</li>
                                <li>‚Ä¢ New targets generate automatically</li>
                            </ul>
                        </li>
                        <li><strong>üìä Scoring:</strong> Base score + distance bonus + speed bonus. Location accuracy
                            affects multiplier.</li>
                        <li><strong>üí• Collision:</strong> Game ends when hitting red enemy cars. Target progress is
                            saved.</li>
                        <li><strong>üÜô Levels:</strong> Speed increases every 500 points. More targets appear at higher
                            levels.</li>
                        <li><strong>üó∫Ô∏è Map View:</strong> Check your location, targets, and progress on the interactive
                            map.</li>
                        <li><strong>üîí Privacy:</strong> Location data is only used for gameplay and never stored or
                            shared.</li>
                    </ol>

                    <div class="mt-8 flex flex-col sm:flex-row gap-4">
                        <button onclick="showLocationMap()"
                            class="bg-location-blue text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                            üó∫Ô∏è View Map
                        </button>
                        <button onclick="showGame()"
                            class="bg-game-tomato text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                            üöó Start Racing!
                        </button>
                        <button onclick="showHome()"
                            class="bg-game-teal text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                            üè† Back to Home
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden">
        <div class="game-container">
            <!-- Ultra Compact Game UI Bar -->
            <div class="game-ui-bar fixed top-16 md:top-20 left-0 right-0 z-30 px-2">
                <div class="flex flex-wrap justify-between items-center h-full max-w-screen-xl mx-auto">
                    <!-- Left side: Score, Level, Targets -->
                    <div class="flex gap-1 flex-wrap items-center">
                        <div class="game-ui-ultra-compact bg-game-teal">
                            Score: <span id="currentScore">0</span>
                        </div>
                        <div class="game-ui-ultra-compact bg-game-teal">
                            Lv: <span id="currentLevel">1</span>
                        </div>
                        <div class="game-ui-ultra-compact target-indicator-ultra-compact">
                            üéØ <span id="targetsCollected">0</span>
                        </div>
                    </div>

                    <!-- Right side: Speed, Distance, Controls -->
                    <div class="flex gap-1 items-center flex-wrap">
                        <div class="game-ui-ultra-compact speed-indicator-ultra-compact">
                            <span id="currentSpeed">0</span>kmh
                        </div>
                        <div class="game-ui-ultra-compact distance-indicator-ultra-compact">
                            <span id="targetDistance">-</span>m
                        </div>
                        <div class="flex gap-1">
                            <div id="acceleratorIcon" class="control-icon-ultra-compact bg-game-green opacity-50">
                                <span class="text-white">‚¨Ü</span>
                            </div>
                            <div id="brakeIcon" class="control-icon-ultra-compact bg-game-red opacity-50">
                                <span class="text-white">‚¨á</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Countdown Screen -->
            <div id="countdownScreen"
                class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-30">
                <div class="text-center">
                    <div id="countdownNumber" class="countdown text-white mb-4">3</div>
                    <div class="text-white text-xl md:text-2xl">Get Ready to Race!</div>
                    <div class="text-white text-sm mt-2">üéØ Collect targets while avoiding traffic</div>
                </div>
            </div>

            <!-- Target Reached Animation -->
            <div id="targetReachedAnimation" class="target-reached-animation hidden">
                üéØ Target Reached! +<span id="targetPoints">100</span> points
            </div>

            <!-- Game Over Screen -->
            <div id="gameOverScreen"
                class="hidden fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-30 p-4">
                <div class="bg-white rounded-lg p-6 md:p-8 text-center max-w-md w-full mx-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-game-red mb-4">üèÅ Race Finished!</h2>
                    <div id="collisionInfo" class="mb-4">
                        <p class="text-base md:text-lg mb-2">Your car collided with:</p>
                        <div class="flex justify-center items-center gap-4 mb-4">
                            <div id="collidedCarImage"
                                class="w-12 h-24 md:w-16 md:h-32 bg-cover bg-center border-2 border-red-500 rounded">
                            </div>
                            <span class="text-xl">üí•</span>
                            <div class="w-12 h-24 md:w-16 md:h-32 bg-cover bg-center border-2 border-green-500 rounded"
                                style="background-image: url('car1.png')"></div>
                        </div>
                    </div>
                    <div class="mb-6 space-y-2">
                        <p class="text-base md:text-lg">Final Score: <span id="finalScore"
                                class="font-bold text-game-teal">0</span></p>
                        <p class="text-base md:text-lg">Targets Reached: <span id="finalTargets"
                                class="font-bold text-game-green">0</span></p>
                        <p class="text-base md:text-lg">Level Reached: <span id="finalLevel"
                                class="font-bold text-game-teal">1</span></p>
                        <p class="text-base md:text-lg">Distance: <span id="finalDistance"
                                class="font-bold text-location-blue">0m</span></p>
                        <p class="text-base md:text-lg">High Score: <span id="gameOverHighScore"
                                class="font-bold text-game-tomato">0</span></p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="restartGame()"
                            class="bg-game-green text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                            üîÑ Restart Race
                        </button>
                        <button onclick="showLocationMap()"
                            class="bg-location-blue text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                            üó∫Ô∏è View Map
                        </button>
                        <button onclick="showHome()"
                            class="bg-game-teal text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition-colors">
                            üè† Home
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Area Container -->
            <div class="flex justify-center items-center p-4 pt-20">
                <div class="relative">
                    <!-- Background Elements -->
                    <div
                        class="backgroundLeft absolute -left-16 md:-left-32 lg:-left-64 top-0 w-16 md:w-32 lg:w-64 h-80 md:h-96 lg:h-[570px]">
                    </div>
                    <div
                        class="backgroundRight absolute -right-16 md:-right-32 lg:-right-64 top-0 w-16 md:w-32 lg:w-64 h-80 md:h-96 lg:h-[570px]">
                    </div>

                    <!-- Start Screen -->
                    <div id="startScreen"
                        class="StartScreen absolute inset-0 bg-green-800 bg-opacity-95 text-white z-10 flex flex-col justify-center items-center text-center p-4 md:p-6 rounded-lg shadow-2xl">
                        <div class="mb-4 md:mb-6">
                            <h3 class="text-xl md:text-2xl lg:text-3xl font-bold mb-4">üèÅ Ready for Location Racing?
                            </h3>
                            <div class="flex justify-center items-center gap-2 md:gap-4 mb-4">
                                <div class="text-center">
                                    <div class="w-12 h-24 md:w-16 md:h-32 bg-cover bg-center border-2 border-green-500 rounded mx-auto mb-2"
                                        style="background-image: url('car1.png')"></div>
                                    <p class="text-xs md:text-sm">Your Car</p>
                                </div>
                                <span class="text-lg md:text-2xl">VS</span>
                                <div class="text-center">
                                    <div class="flex gap-1">
                                        <div class="w-6 h-12 md:w-8 md:h-16 bg-cover bg-center border border-red-500 rounded"
                                            style="background-image: url('car2.png')"></div>
                                        <div class="w-6 h-12 md:w-8 md:h-16 bg-cover bg-center border border-red-500 rounded"
                                            style="background-image: url('car3.png')"></div>
                                        <div class="w-6 h-12 md:w-8 md:h-16 bg-cover bg-center border border-red-500 rounded"
                                            style="background-image: url('car4.png')"></div>
                                        <div class="w-6 h-12 md:w-8 md:h-16 bg-cover bg-center border border-red-500 rounded"
                                            style="background-image: url('car5.png')"></div>
                                    </div>
                                    <p class="text-xs md:text-sm mt-2">Traffic</p>
                                </div>
                                <span class="text-lg md:text-2xl">+</span>
                                <div class="text-center">
                                    <div
                                        class="w-12 h-6 md:w-16 md:h-8 bg-gradient-to-r from-green-400 to-green-600 border-2 border-green-500 rounded-full mx-auto mb-2 flex items-center justify-center">
                                        <span class="text-xs font-bold">üéØ</span>
                                    </div>
                                    <p class="text-xs md:text-sm">Targets</p>
                                </div>
                            </div>
                        </div>
                        <p class="text-base md:text-lg lg:text-xl mb-4 md:mb-6 leading-relaxed">
                            üó∫Ô∏è Race through real locations<br>
                            üéØ Collect targets to score points<br>
                            <span class="text-xs md:text-sm">Use Arrow Keys or Touch Controls</span>
                        </p>
                        <div class="flex flex-col sm:flex-row gap-3 md:gap-4 w-full max-w-sm">
                            <button onclick="startGameCountdown()"
                                class="bg-game-green text-white px-6 py-3 md:px-8 md:py-4 rounded-lg text-lg md:text-xl font-bold hover:bg-opacity-90 transition-colors transform hover:scale-105 w-full sm:w-auto">
                                üöó Start Race
                            </button>
                            <button onclick="showLocationMap()"
                                class="bg-location-blue text-white px-4 py-3 md:px-6 md:py-3 rounded-lg text-sm md:text-base hover:bg-opacity-90 transition-colors w-full sm:w-auto">
                                üó∫Ô∏è View Map
                            </button>
                            <button onclick="resetHighScore()"
                                class="bg-game-red text-white px-4 py-3 md:px-6 md:py-3 rounded-lg text-sm md:text-base hover:bg-opacity-90 transition-colors w-full sm:w-auto">
                                üîÑ Reset Score
                            </button>
                        </div>
                    </div>

                    <!-- Game Area -->
                    <div
                        class="GameArea bg-gray-800 relative overflow-hidden border-l-4 border-r-4 md:border-l-8 md:border-r-8 border-dashed border-white rounded-lg">
                    </div>
                </div>
            </div>

            <!-- Mobile Controls - 2x2 Grid Layout -->
            <div id="mobileControls"
                class="mobile-controls-compact fixed left-1/2 transform -translate-x-1/2 md:hidden z-20">
                <div class="bg-black bg-opacity-70 rounded-lg p-3">
                    <div class="control-grid-2x2 grid grid-cols-2 gap-2">
                        <!-- Top Row: Up and Down -->
                        <button id="upBtn"
                            class="bg-game-green text-white rounded-lg font-bold active:bg-opacity-80 transition-all">
                            <span>‚¨Ü</span>
                        </button>
                        <button id="downBtn"
                            class="bg-game-red text-white rounded-lg font-bold active:bg-opacity-80 transition-all">
                            <span>‚¨á</span>
                        </button>
                        <!-- Bottom Row: Left and Right -->
                        <button id="leftBtn"
                            class="bg-game-teal text-white rounded-lg font-bold active:bg-opacity-80 transition-all">
                            <span>‚Üê</span>
                        </button>
                        <button id="rightBtn"
                            class="bg-game-teal text-white rounded-lg font-bold active:bg-opacity-80 transition-all">
                            <span>‚Üí</span>
                        </button>
                    </div>
                    <div class="text-center mt-2 text-white text-xs">Touch Controls</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        const backgroundMusic = document.getElementById('backgroundMusic');
        const collisionSound = document.getElementById('collisionSound');
        const scoreSound = document.getElementById('scoreSound');
        const accelerationSound = document.getElementById('accelerationSound');
        const brakeSound = document.getElementById('brakeSound');
        const countdownSound = document.getElementById('countdownSound');
        const targetReachedSound = document.getElementById('targetReachedSound');

        const score = document.getElementById('currentScore');
        const level = document.getElementById('currentLevel');
        const speedDisplay = document.getElementById('currentSpeed');
        const acceleratorIcon = document.getElementById('acceleratorIcon');
        const brakeIcon = document.getElementById('brakeIcon');
        const topHighScore = document.getElementById('topHighScore');
        const targetsCollected = document.getElementById('targetsCollected');
        const targetDistance = document.getElementById('targetDistance');

        let startscreen, gamearea;
        let player = { speed: 5, score: 0, baseSpeed: 5, kmph: 50, x: 0, y: 0 };
        let gameData = {
            highScore: parseInt(localStorage.getItem('locationRaceHighScore')) || 0,
            totalGames: parseInt(localStorage.getItem('locationRaceTotalGames')) || 0,
            totalScore: parseInt(localStorage.getItem('locationRaceTotalScore')) || 0,
            lastLevel: parseInt(localStorage.getItem('locationRaceLastLevel')) || 1,
            targetsReached: parseInt(localStorage.getItem('locationRaceTargetsReached')) || 0,
            totalDistance: parseInt(localStorage.getItem('locationRaceTotalDistance')) || 0
        };
        let currentLevel = 1;
        let gameover = false;
        let gameStarted = false;
        let collidedCar = null;
        let currentTargetsCollected = 0;
        let currentDistanceTraveled = 0;

        // Location-based variables
        let locationEnabled = false;
        let currentLocation = null;
        let watchId = null;
        let map = null;
        let userMarker = null;
        let targetMarkers = [];
        let targetAreas = [];
        let currentTargetIndex = 0;
        let routeLine = null;

        const carImages = ['car2.png', 'car3.png', 'car4.png', 'car5.png'];
        let keys = { ArrowUp: false, ArrowDown: false, ArrowRight: false, ArrowLeft: false };

        // Location Management
        function showLocationModal() {
            document.getElementById('locationModal').classList.remove('hidden');
        }

        function hideLocationModal() {
            document.getElementById('locationModal').classList.add('hidden');
        }

        function requestLocationPermission() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                playWithoutLocation();
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    locationEnabled = true;
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    updateLocationDisplay();
                    updateGPSStatus(true);
                    generateTargetAreas();
                    hideLocationModal();

                    // Start watching position
                    watchId = navigator.geolocation.watchPosition(
                        updateLocation,
                        handleLocationError,
                        options
                    );
                },
                (error) => {
                    console.error('Location error:', error);
                    handleLocationError(error);
                },
                options
            );
        }

        function playWithoutLocation() {
            locationEnabled = false;
            updateGPSStatus(false);
            hideLocationModal();
            // Generate mock target areas for gameplay
            generateMockTargetAreas();
        }

        function updateLocation(position) {
            currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            updateLocationDisplay();
            updateMapPosition();
            checkTargetProximity();
        }

        function handleLocationError(error) {
            console.error('Location error:', error);
            updateGPSStatus(false);

            let errorMessage = 'Location access denied. ';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Please enable location access to use GPS racing.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out.';
                    break;
            }

            document.getElementById('locationText').textContent = errorMessage;

            // Offer to play without location after 3 seconds
            setTimeout(() => {
                if (confirm(errorMessage + '\n\nWould you like to play without location features?')) {
                    playWithoutLocation();
                }
            }, 3000);
        }

        function updateLocationDisplay() {
            if (!currentLocation) return;

            const locationText = document.getElementById('locationText');
            const accuracy = Math.round(currentLocation.accuracy);

            locationText.innerHTML = `
                üìç ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}<br>
                üì° Accuracy: ¬±${accuracy}m
            `;

            // Update accuracy display
            document.getElementById('locationAccuracy').textContent = `¬±${accuracy}m`;
        }

        function updateGPSStatus(active) {
            const gpsStatus = document.getElementById('gpsStatus');
            if (active) {
                gpsStatus.textContent = 'GPS: ON';
                gpsStatus.className = 'gps-status active';
            } else {
                gpsStatus.textContent = 'GPS: OFF';
                gpsStatus.className = 'gps-status inactive';
            }
        }

        function refreshLocation() {
            if (locationEnabled && navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    updateLocation,
                    handleLocationError,
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            }
        }

        // Target Area Management
        function generateTargetAreas() {
            if (!currentLocation) return;

            targetAreas = [];
            const baseDistance = 0.001; // Approximately 100m

            // Generate 5 target areas around current location
            for (let i = 0; i < 5; i++) {
                const angle = (i * 72) * (Math.PI / 180); // 72 degrees apart
                const distance = baseDistance * (1 + Math.random() * 2); // 100-300m

                const targetLat = currentLocation.lat + (distance * Math.cos(angle));
                const targetLng = currentLocation.lng + (distance * Math.sin(angle));

                targetAreas.push({
                    id: i,
                    lat: targetLat,
                    lng: targetLng,
                    collected: false,
                    distance: calculateDistance(currentLocation.lat, currentLocation.lng, targetLat, targetLng),
                    points: Math.round(100 + (distance * 10000)) // Points based on distance
                });
            }

            updateMapTargets();
            updateTargetInfo();
        }

        function generateMockTargetAreas() {
            // Generate mock targets for non-location gameplay
            targetAreas = [];
            for (let i = 0; i < 5; i++) {
                targetAreas.push({
                    id: i,
                    lat: 0,
                    lng: 0,
                    collected: false,
                    distance: Math.round(100 + Math.random() * 500),
                    points: Math.round(100 + Math.random() * 200)
                });
            }
            updateTargetInfo();
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return Math.round(R * c);
        }

        function checkTargetProximity() {
            if (!currentLocation || !gameStarted) return;

            const proximityThreshold = 50; // 50 meters

            targetAreas.forEach(target => {
                if (!target.collected) {
                    const distance = calculateDistance(
                        currentLocation.lat, currentLocation.lng,
                        target.lat, target.lng
                    );

                    if (distance <= proximityThreshold) {
                        collectTarget(target);
                    }
                }
            });
        }

        function collectTarget(target) {
            target.collected = true;
            currentTargetsCollected++;

            // Add points to score
            player.score += target.points;
            score.textContent = player.score;

            // Update displays
            targetsCollected.textContent = currentTargetsCollected;

            // Show target reached animation
            showTargetReachedAnimation(target.points);

            // Play sound
            playTargetReachedSound();

            // Remove from map
            updateMapTargets();

            // Generate new target
            generateNewTarget();

            // Update game statistics
            gameData.targetsReached++;
            saveGameData();
        }

        function generateNewTarget() {
            if (!currentLocation) return;

            const baseDistance = 0.001;
            const angle = Math.random() * 2 * Math.PI;
            const distance = baseDistance * (1 + Math.random() * 3);

            const targetLat = currentLocation.lat + (distance * Math.cos(angle));
            const targetLng = currentLocation.lng + (distance * Math.sin(angle));

            const newTarget = {
                id: Date.now(),
                lat: targetLat,
                lng: targetLng,
                collected: false,
                distance: calculateDistance(currentLocation.lat, currentLocation.lng, targetLat, targetLng),
                points: Math.round(100 + (distance * 10000))
            };

            targetAreas.push(newTarget);
            updateMapTargets();
        }

        function showTargetReachedAnimation(points) {
            const animation = document.getElementById('targetReachedAnimation');
            document.getElementById('targetPoints').textContent = points;
            animation.classList.remove('hidden');

            setTimeout(() => {
                animation.classList.add('hidden');
            }, 2000);
        }

        function updateTargetInfo() {
            const uncollectedTargets = targetAreas.filter(t => !t.collected);
            const currentTargetDisplay = document.getElementById('currentTarget');
            const targetDistanceDisplay = document.getElementById('targetDistance');

            if (uncollectedTargets.length > 0) {
                const nearestTarget = uncollectedTargets.reduce((nearest, target) =>
                    target.distance < nearest.distance ? target : nearest
                );

                currentTargetDisplay.textContent = `#${nearestTarget.id}`;
                targetDistanceDisplay.textContent = nearestTarget.distance;
            } else {
                currentTargetDisplay.textContent = '-';
                targetDistanceDisplay.textContent = '-';
            }

            // Update statistics
            document.getElementById('targetsReached').textContent = currentTargetsCollected;
            document.getElementById('totalDistance').textContent = `${currentDistanceTraveled}m`;
        }

        // Map Management
        function initializeMap() {
            if (!map) {
                map = L.map('mapContainer').setView([51.505, -0.09], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            }

            if (currentLocation) {
                map.setView([currentLocation.lat, currentLocation.lng], 15);
                updateMapPosition();
            }
        }

        function updateMapPosition() {
            if (!map || !currentLocation) return;

            // Update user marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }

            userMarker = L.marker([currentLocation.lat, currentLocation.lng])
                .addTo(map)
                .bindPopup('üöó Your Location')
                .openPopup();

            // Update accuracy circle
            L.circle([currentLocation.lat, currentLocation.lng], {
                color: 'blue',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                radius: currentLocation.accuracy
            }).addTo(map);
        }

        function updateMapTargets() {
            if (!map) return;

            // Clear existing target markers
            targetMarkers.forEach(marker => map.removeLayer(marker));
            targetMarkers = [];

            // Add new target markers
            targetAreas.forEach(target => {
                if (!target.collected && target.lat && target.lng) {
                    const marker = L.marker([target.lat, target.lng], {
                        icon: L.divIcon({
                            className: 'target-marker',
                            html: 'üéØ',
                            iconSize: [30, 30]
                        })
                    })
                        .addTo(map)
                        .bindPopup(`üéØ Target #${target.id}<br>Distance: ${target.distance}m<br>Points: ${target.points}`);

                    targetMarkers.push(marker);
                }
            });
        }

        // Game Initialization and Management
        function updateGameDataDisplay() {
            topHighScore.textContent = gameData.highScore;
            document.getElementById('gameOverHighScore').textContent = gameData.highScore;
        }

        function saveGameData() {
            localStorage.setItem('locationRaceHighScore', gameData.highScore.toString());
            localStorage.setItem('locationRaceTotalGames', gameData.totalGames.toString());
            localStorage.setItem('locationRaceTotalScore', gameData.totalScore.toString());
            localStorage.setItem('locationRaceLastLevel', gameData.lastLevel.toString());
            localStorage.setItem('locationRaceTargetsReached', gameData.targetsReached.toString());
            localStorage.setItem('locationRaceTotalDistance', gameData.totalDistance.toString());
        }

        function convertToKmph(gameSpeed) {
            return Math.round((gameSpeed / 15) * 200);
        }

        // Screen Management
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburger = document.getElementById('hamburger');
            const close = document.getElementById('close');

            mobileMenu.classList.toggle('active');
            hamburger.classList.toggle('hidden');
            close.classList.toggle('hidden');
        }

        function showHome() {
            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('rulesScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('locationMapScreen').classList.add('hidden');
            stopAllAudio();
        }

        function showRules() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('rulesScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('locationMapScreen').classList.add('hidden');
            stopAllAudio();
        }

        function showLocationMap() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('rulesScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('locationMapScreen').classList.remove('hidden');
            stopAllAudio();

            setTimeout(() => {
                initializeMap();
                if (!locationEnabled) {
                    showLocationModal();
                }
            }, 100);
        }

        function showGame() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('rulesScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('locationMapScreen').classList.add('hidden');

            if (!locationEnabled) {
                showLocationModal();
            }

            setTimeout(initializeGame, 100);
        }

        function initializeGame() {
            startscreen = document.getElementById('startScreen');
            gamearea = document.querySelector('.GameArea');

            // Reset game state
            player = { speed: 5, score: 0, baseSpeed: 5, kmph: 50, x: 0, y: 0 };
            currentLevel = 1;
            gameover = false;
            gameStarted = false;
            currentTargetsCollected = 0;
            currentDistanceTraveled = 0;

            // Update displays
            score.textContent = '0';
            level.textContent = '1';
            speedDisplay.textContent = '50';
            targetsCollected.textContent = '0';
            targetDistance.textContent = '-';
            updateGameDataDisplay();

            // Generate targets if not already done
            if (targetAreas.length === 0) {
                if (locationEnabled) {
                    generateTargetAreas();
                } else {
                    generateMockTargetAreas();
                }
            }

            // Show start screen
            startscreen.classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('countdownScreen').classList.add('hidden');
        }

        function startGameCountdown() {
            const countdownScreen = document.getElementById('countdownScreen');
            const countdownNumber = document.getElementById('countdownNumber');

            startscreen.classList.add('hidden');
            countdownScreen.classList.remove('hidden');

            let count = 3;
            countdownNumber.textContent = count;
            countdownNumber.style.color = '#ffffff';
            countdownSound.play();

            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownNumber.textContent = count;
                    countdownSound.play();
                } else if (count === 0) {
                    countdownNumber.textContent = 'GO!';
                    countdownNumber.style.color = '#22c55e';
                    countdownSound.play();
                } else {
                    clearInterval(countdownInterval);
                    countdownScreen.classList.add('hidden');
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            gamearea.innerHTML = "";
            gameStarted = true;
            player.start = true;
            player.score = 0;
            currentLevel = 1;
            player.speed = 5;
            player.baseSpeed = 5;
            player.kmph = 50;
            gameover = false;

            // Update displays
            level.textContent = currentLevel;
            speedDisplay.textContent = player.kmph;

            // Start background music
            backgroundMusic.play();

            // Create road lines
            for (let x = 0; x < 5; x++) {
                let roadline = document.createElement('div');
                roadline.setAttribute('class', 'lines');
                roadline.y = (x * 150);
                roadline.style.top = roadline.y + 'px';
                gamearea.appendChild(roadline);
            }

            // Create user car
            let userCar = document.createElement('div');
            userCar.setAttribute('class', 'UserCar');
            gamearea.appendChild(userCar);

            player.x = userCar.offsetLeft;
            player.y = userCar.offsetTop;

            // Create enemy cars
            for (let x = 0; x < 3; x++) {
                let enemyCar = document.createElement('div');
                enemyCar.setAttribute('class', 'other');
                enemyCar.carType = carImages[Math.floor(Math.random() * carImages.length)];
                enemyCar.style.backgroundImage = `url(${enemyCar.carType})`;
                enemyCar.y = ((x + 1) * 350) * -1;
                enemyCar.style.top = enemyCar.y + 'px';
                enemyCar.style.left = Math.floor(Math.random() * 280) + 'px';
                gamearea.appendChild(enemyCar);
            }

            // Create target areas in game
            createGameTargets();

            window.requestAnimationFrame(gamePlay);
        }

        function createGameTargets() {
            // Create visual target areas in the game
            const numTargets = Math.min(3, targetAreas.filter(t => !t.collected).length);

            for (let i = 0; i < numTargets; i++) {
                let targetArea = document.createElement('div');
                targetArea.setAttribute('class', 'target-area');
                targetArea.textContent = 'üéØ';
                targetArea.targetId = i;
                targetArea.y = -200 - (i * 300);
                targetArea.style.top = targetArea.y + 'px';
                targetArea.style.left = Math.floor(Math.random() * 320) + 'px';
                gamearea.appendChild(targetArea);
            }
        }

        function restartGame() {
            document.getElementById('gameOverScreen').classList.add('hidden');
            startGameCountdown();
        }

        function resetHighScore() {
            gameData.highScore = 0;
            gameData.totalGames = 0;
            gameData.totalScore = 0;
            gameData.lastLevel = 1;
            gameData.targetsReached = 0;
            gameData.totalDistance = 0;
            saveGameData();
            updateGameDataDisplay();

            alert('All game data has been reset!');
        }

        // Key Event Handlers
        document.addEventListener('keydown', keyDown);
        document.addEventListener('keyup', keyUp);

        function keyDown(ev) {
            if (!gameStarted) return;
            ev.preventDefault();
            keys[ev.key] = true;

            if (ev.key === 'ArrowUp') {
                player.speed = Math.min(player.baseSpeed + 5, 15);
                player.kmph = convertToKmph(player.speed);
                speedDisplay.textContent = player.kmph;
                acceleratorIcon.style.opacity = '1';
                acceleratorIcon.classList.add('animate-pulse-fast');
                playAccelerationSound();
            } else if (ev.key === 'ArrowDown') {
                player.speed = Math.max(player.baseSpeed - 3, 1);
                player.kmph = convertToKmph(player.speed);
                speedDisplay.textContent = player.kmph;
                brakeIcon.style.opacity = '1';
                brakeIcon.classList.add('animate-pulse-fast');
                playBrakeSound();
            }
        }

        function keyUp(ev) {
            if (!gameStarted) return;
            ev.preventDefault();
            keys[ev.key] = false;

            if (ev.key === 'ArrowUp') {
                player.speed = player.baseSpeed;
                player.kmph = convertToKmph(player.speed);
                speedDisplay.textContent = player.kmph;
                acceleratorIcon.style.opacity = '0.5';
                acceleratorIcon.classList.remove('animate-pulse-fast');
                accelerationSound.pause();
            } else if (ev.key === 'ArrowDown') {
                player.speed = player.baseSpeed;
                player.kmph = convertToKmph(player.speed);
                speedDisplay.textContent = player.kmph;
                brakeIcon.style.opacity = '0.5';
                brakeIcon.classList.remove('animate-pulse-fast');
                brakeSound.pause();
            }
        }

        // Collision Detection
        function isCollide(a, b) {
            const aRect = a.getBoundingClientRect();
            const bRect = b.getBoundingClientRect();
            return !((aRect.bottom < bRect.top) || (aRect.top > bRect.bottom) ||
                (aRect.right < bRect.left) || (aRect.left > bRect.right));
        }

        // Move Road Lines
        function moveLines() {
            let lines = document.querySelectorAll('.lines');
            lines.forEach(function (item) {
                if (item.y >= 700) {
                    item.y -= 750;
                }
                item.y += player.speed;
                item.style.top = item.y + 'px';
            });
        }

        // Move Target Areas
        function moveTargetAreas() {
            let targets = document.querySelectorAll('.target-area');
            targets.forEach(function (target) {
                if (target.y >= 750) {
                    target.y = -200;
                    target.style.left = Math.floor(Math.random() * 320) + 'px';
                }
                target.y += player.speed;
                target.style.top = target.y + 'px';
            });
        }

        // Check Target Collection
        function checkTargetCollection(userCar) {
            let targets = document.querySelectorAll('.target-area');
            targets.forEach(function (target) {
                if (isCollide(userCar, target)) {
                    // Collect target
                    const points = 100 + (currentLevel * 50);
                    player.score += points;
                    score.textContent = player.score;
                    currentTargetsCollected++;
                    targetsCollected.textContent = currentTargetsCollected;

                    // Show animation
                    showTargetReachedAnimation(points);
                    playTargetReachedSound();

                    // Remove target and create new one
                    target.remove();

                    // Create new target
                    setTimeout(() => {
                        let newTarget = document.createElement('div');
                        newTarget.setAttribute('class', 'target-area');
                        newTarget.textContent = 'üéØ';
                        newTarget.y = -200;
                        newTarget.style.top = newTarget.y + 'px';
                        newTarget.style.left = Math.floor(Math.random() * 320) + 'px';
                        gamearea.appendChild(newTarget);
                    }, 1000);
                }
            });
        }

        // End Game Function
        function endGame(collidedEnemyCar) {
            player.start = false;
            gameStarted = false;
            gameover = true;
            collidedCar = collidedEnemyCar;

            // Update game statistics
            gameData.totalGames++;
            gameData.totalScore += player.score;
            gameData.lastLevel = currentLevel;
            gameData.targetsReached += currentTargetsCollected;
            gameData.totalDistance += currentDistanceTraveled;

            // Stop audio
            backgroundMusic.pause();
            accelerationSound.pause();
            brakeSound.pause();

            // Reset speed indicators
            acceleratorIcon.style.opacity = '0.5';
            brakeIcon.style.opacity = '0.5';
            acceleratorIcon.classList.remove('animate-pulse-fast');
            brakeIcon.classList.remove('animate-pulse-fast');

            // Update high score
            if (player.score > gameData.highScore) {
                gameData.highScore = player.score;
            }

            // Save game data
            saveGameData();
            updateGameDataDisplay();

            // Show collision effect
            if (collidedEnemyCar) {
                collidedEnemyCar.classList.add('collision-highlight');
                document.getElementById('collidedCarImage').style.backgroundImage =
                    `url(${collidedEnemyCar.carType})`;
            }

            // Update game over screen
            document.getElementById('finalScore').textContent = player.score;
            document.getElementById('finalTargets').textContent = currentTargetsCollected;
            document.getElementById('finalLevel').textContent = currentLevel;
            document.getElementById('finalDistance').textContent = currentDistanceTraveled;
            document.getElementById('gameOverHighScore').textContent = gameData.highScore;

            // Show game over screen after a short delay
            setTimeout(() => {
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }, 1000);
        }

        // Move Cars Function
        function moveCars(userCar) {
            let enemyCars = document.querySelectorAll('.other');
            enemyCars.forEach(function (enemyCar) {
                if (isCollide(userCar, enemyCar)) {
                    console.log('COLLISION!');
                    playCollisionSound();
                    endGame(enemyCar);
                    return;
                }

                if (enemyCar.y >= 750) {
                    enemyCar.y = -300;
                    enemyCar.style.left = Math.floor(Math.random() * 280) + 'px';
                    // Change car type randomly
                    enemyCar.carType = carImages[Math.floor(Math.random() * carImages.length)];
                    enemyCar.style.backgroundImage = `url(${enemyCar.carType})`;
                }

                enemyCar.y += player.speed;
                enemyCar.style.top = enemyCar.y + 'px';
            });
        }

        // Main Game Loop
        function gamePlay() {
            let userCar = document.querySelector('.UserCar');
            if (!gamearea || !userCar || !player.start) return;

            let road = gamearea.getBoundingClientRect();

            if (player.start) {
                moveLines();
                moveTargetAreas();
                moveCars(userCar);
                checkTargetCollection(userCar);

                // Handle movement with improved boundaries
                if (keys.ArrowUp && player.y > (road.top + 50)) {
                    player.y -= player.speed;
                }
                if (keys.ArrowDown && player.y < (road.bottom - 120)) {
                    player.y += player.speed;
                }
                if (keys.ArrowLeft && player.x > 0) {
                    player.x -= player.speed;
                }
                if (keys.ArrowRight && player.x < (road.width - 50)) {
                    player.x += player.speed;
                }

                userCar.style.top = player.y + 'px';
                userCar.style.left = player.x + 'px';

                // Update score and level
                player.score++;
                score.textContent = player.score;
                updateLevel();

                // Update distance traveled
                currentDistanceTraveled += Math.round(player.speed / 10);
                updateTargetInfo();

                window.requestAnimationFrame(gamePlay);
            }
        }

        // Update Level Function
        function updateLevel() {
            if (player.score % 500 === 0 && player.score > 0) {
                currentLevel++;
                player.baseSpeed = Math.min(player.baseSpeed + 1, 12);
                player.speed = player.baseSpeed;
                player.kmph = convertToKmph(player.speed);
                level.textContent = currentLevel;
                speedDisplay.textContent = player.kmph;
                playScoreSound();
            }
        }

        // Audio Functions
        function playCollisionSound() {
            collisionSound.currentTime = 0;
            collisionSound.play();
        }

        function playScoreSound() {
            scoreSound.currentTime = 0;
            scoreSound.play();
        }

        function playTargetReachedSound() {
            targetReachedSound.currentTime = 0;
            targetReachedSound.play();
        }

        function playAccelerationSound() {
            accelerationSound.play();
        }

        function playBrakeSound() {
            brakeSound.play();
        }

        function stopAllAudio() {
            backgroundMusic.pause();
            collisionSound.pause();
            scoreSound.pause();
            accelerationSound.pause();
            brakeSound.pause();
            countdownSound.pause();
            targetReachedSound.pause();
        }

        // Mobile Touch Controls
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', function (e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function (e) {
            if (!gameStarted) return;

            let touchEndX = e.changedTouches[0].clientX;
            let touchEndY = e.changedTouches[0].clientY;

            let deltaX = touchEndX - touchStartX;
            let deltaY = touchEndY - touchStartY;

            // Determine swipe direction
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX > 30) {
                    simulateKeyPress('ArrowRight');
                } else if (deltaX < -30) {
                    simulateKeyPress('ArrowLeft');
                }
            } else {
                if (deltaY > 30) {
                    simulateKeyPress('ArrowDown');
                } else if (deltaY < -30) {
                    simulateKeyPress('ArrowUp');
                }
            }
        });

        function simulateKeyPress(key) {
            keys[key] = true;
            keyDown({ key: key, preventDefault: () => { } });
            setTimeout(() => {
                keys[key] = false;
                keyUp({ key: key, preventDefault: () => { } });
            }, 150);
        }

        // Mobile Control Buttons
        function initializeMobileControls() {
            const upBtn = document.getElementById('upBtn');
            const downBtn = document.getElementById('downBtn');
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');

            // Up button (Accelerate)
            upBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!gameStarted) return;
                keys.ArrowUp = true;
                keyDown({ key: 'ArrowUp', preventDefault: () => { } });
            });
            upBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys.ArrowUp = false;
                keyUp({ key: 'ArrowUp', preventDefault: () => { } });
            });

            // Down button (Brake)
            downBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!gameStarted) return;
                keys.ArrowDown = true;
                keyDown({ key: 'ArrowDown', preventDefault: () => { } });
            });
            downBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys.ArrowDown = false;
                keyUp({ key: 'ArrowDown', preventDefault: () => { } });
            });

            // Left button
            leftBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!gameStarted) return;
                keys.ArrowLeft = true;
            });
            leftBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys.ArrowLeft = false;
            });

            // Right button
            rightBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!gameStarted) return;
                keys.ArrowRight = true;
            });
            rightBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys.ArrowRight = false;
            });

            // Prevent context menu on long press
            [upBtn, downBtn, leftBtn, rightBtn].forEach(btn => {
                btn.addEventListener('contextmenu', (e) => e.preventDefault());
            });
        }

        // Responsive Game Area
        function adjustGameArea() {
            const gameArea = document.querySelector('.GameArea');
            if (gameArea) {
                if (window.innerWidth < 768) {
                    gameArea.style.width = '288px';
                    gameArea.style.height = '320px';
                } else if (window.innerWidth < 1024) {
                    gameArea.style.width = '320px';
                    gameArea.style.height = '384px';
                } else {
                    gameArea.style.width = '384px';
                    gameArea.style.height = '600px';
                }
            }
        }

        // Event Listeners
        window.addEventListener('resize', adjustGameArea);
        window.addEventListener('orientationchange', adjustGameArea);

        window.addEventListener('beforeunload', function (event) {
            if (!gameover && gameStarted) {
                stopAllAudio();
                saveGameData();
            }

            // Stop location watching
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            adjustGameArea();
            initializeMobileControls();
            updateGameDataDisplay();

            // Close mobile menu when clicking outside
            document.addEventListener('click', function (e) {
                const mobileMenu = document.getElementById('mobileMenu');
                const nav = document.querySelector('nav');

                if (!nav.contains(e.target) && mobileMenu.classList.contains('active')) {
                    toggleMobileMenu();
                }
            });

            // Initialize location on first load
            setTimeout(() => {
                if (!locationEnabled) {
                    showLocationModal();
                }
            }, 1000);
        });

        // Prevent zoom on double tap for mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Prevent scrolling when touching the game area
        document.addEventListener('touchmove', function (e) {
            if (e.target.closest('.GameArea') || e.target.closest('#mobileControls')) {
                e.preventDefault();
            }
        }, { passive: false });

        // Additional mobile optimizations
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        // Keyboard controls info for desktop
        document.addEventListener('keydown', function (e) {
            if (gameStarted && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.key)) {
                e.preventDefault();
            }
        });

        // Performance optimization for mobile
        function optimizeForMobile() {
            if (window.innerWidth < 768) {
                const style = document.createElement('style');
                style.textContent = `
                    .lines {
                        transition: none;
                    }
                    .UserCar, .other, .target-area {
                        transition: none;
                    }
                    .collision-highlight {
                        animation-duration: 0.3s;
                        animation-iteration-count: 2;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        optimizeForMobile();

        // Handle visibility change (when user switches tabs)
        document.addEventListener('visibilitychange', function () {
            if (document.hidden && gameStarted) {
                backgroundMusic.pause();
                accelerationSound.pause();
                brakeSound.pause();
            } else if (!document.hidden && gameStarted && !gameover) {
                backgroundMusic.play();
            }
        });

        // Add loading state for better UX
        function showLoadingState() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingState';
            loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
            loadingDiv.innerHTML = `
                <div class="text-center text-white">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                    <p class="text-xl">Loading Location Racing...</p>
                    <p class="text-sm mt-2">üó∫Ô∏è Preparing GPS features</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoadingState() {
            const loadingDiv = document.getElementById('loadingState');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Preload images for better performance
        function preloadImages() {
            const images = [
                'car1.png', 'car2.png', 'car3.png', 'car4.png', 'car5.png',
                'backgroundImage.png', 'backgroundImage.gif', 'backgroundImageRule.png'
            ];

            let loadedCount = 0;
            const totalImages = images.length;

            images.forEach(src => {
                const img = new Image();
                img.onload = () => {
                    loadedCount++;
                    if (loadedCount === totalImages) {
                        hideLoadingState();
                    }
                };
                img.onerror = () => {
                    loadedCount++;
                    if (loadedCount === totalImages) {
                        hideLoadingState();
                    }
                };
                img.src = src;
            });
        }

        // Initialize loading and preload
        window.addEventListener('load', function () {
            showLoadingState();
            preloadImages();
        });

        // Add game statistics display
        function showGameStats() {
            const statsDiv = document.createElement('div');
            statsDiv.className = 'fixed bottom-4 left-4 bg-black bg-opacity-80 text-white p-3 rounded-lg text-sm z-30';
            statsDiv.innerHTML = `
                <div class="mb-1">üéÆ Games Played: ${gameData.totalGames}</div>
                <div class="mb-1">üìä Total Score: ${gameData.totalScore}</div>
                <div class="mb-1">üéØ Targets Reached: ${gameData.targetsReached}</div>
                <div class="mb-1">üìè Distance: ${gameData.totalDistance}m</div>
                <div>üèÜ Last Level: ${gameData.lastLevel}</div>
            `;

            setTimeout(() => {
                if (statsDiv.parentNode) {
                    statsDiv.remove();
                }
            }, 5000);

            document.body.appendChild(statsDiv);
        }

        // Add keyboard shortcut for stats (press 'S' key)
        document.addEventListener('keydown', function (e) {
            if (e.key.toLowerCase() === 's' && !gameStarted) {
                showGameStats();
            }
        });

        // Enhanced error handling
        window.addEventListener('error', function (e) {
            console.error('Game Error:', e.error);
            if (gameStarted) {
                stopAllAudio();
                alert('An error occurred. The game will restart.');
                showHome();
            }
        });

        // Add pause functionality (spacebar)
        let gamePaused = false;
        document.addEventListener('keydown', function (e) {
            if (e.key === ' ' && gameStarted && !gameover) {
                e.preventDefault();
                togglePause();
            }
        });

        function togglePause() {
            gamePaused = !gamePaused;

            if (gamePaused) {
                backgroundMusic.pause();
                accelerationSound.pause();
                brakeSound.pause();

                const pauseOverlay = document.createElement('div');
                pauseOverlay.id = 'pauseOverlay';
                pauseOverlay.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-40';
                pauseOverlay.innerHTML = `
                    <div class="text-center text-white">
                        <h2 class="text-4xl font-bold mb-4">‚è∏Ô∏è PAUSED</h2>
                        <p class="text-xl mb-4">Press SPACEBAR to resume</p>
                        <div class="text-sm space-y-1">
                            <p>Current Score: ${player.score}</p>
                            <p>Targets Collected: ${currentTargetsCollected}</p>
                            <p>Distance: ${currentDistanceTraveled}m</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(pauseOverlay);
            } else {
                backgroundMusic.play();
                const pauseOverlay = document.getElementById('pauseOverlay');
                if (pauseOverlay) {
                    pauseOverlay.remove();
                }
            }
        }

        // Modify gamePlay function to handle pause
        const originalGamePlay = gamePlay;
        gamePlay = function () {
            if (!gamePaused) {
                originalGamePlay();
            } else {
                if (player.start) {
                    window.requestAnimationFrame(gamePlay);
                }
            }
        };

        // Add sound toggle functionality
        let soundEnabled = localStorage.getItem('locationRaceSoundEnabled') !== 'false';

        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('locationRaceSoundEnabled', soundEnabled.toString());

            if (!soundEnabled) {
                stopAllAudio();
            }

            updateSoundButton();
        }

        function updateSoundButton() {
            const soundBtn = document.getElementById('soundToggle');
            if (soundBtn) {
                soundBtn.textContent = soundEnabled ? 'üîä' : 'üîá';
                soundBtn.title = soundEnabled ? 'Mute Sound' : 'Enable Sound';
            }
        }

        // Add sound toggle button
        function addSoundToggle() {
            const soundBtn = document.createElement('button');
            soundBtn.id = 'soundToggle';
            soundBtn.className = 'fixed top-4 right-20 md:right-24 bg-white text-game-teal px-3 py-2 rounded hover:bg-gray-100 transition-colors z-50';
            soundBtn.onclick = toggleSound;
            updateSoundButton();
            document.body.appendChild(soundBtn);
        }

        // Override audio functions to respect sound setting
        const originalPlayCollisionSound = playCollisionSound;
        const originalPlayScoreSound = playScoreSound;
        const originalPlayTargetReachedSound = playTargetReachedSound;
        const originalPlayAccelerationSound = playAccelerationSound;
        const originalPlayBrakeSound = playBrakeSound;

        playCollisionSound = function () {
            if (soundEnabled) originalPlayCollisionSound();
        };

        playScoreSound = function () {
            if (soundEnabled) originalPlayScoreSound();
        };

        playTargetReachedSound = function () {
            if (soundEnabled) originalPlayTargetReachedSound();
        };

        playAccelerationSound = function () {
            if (soundEnabled) originalPlayAccelerationSound();
        };

        playBrakeSound = function () {
            if (soundEnabled) originalPlayBrakeSound();
        };

        // Add fullscreen support for mobile
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen not supported:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Add fullscreen button for mobile
        function addFullscreenButton() {
            if (window.innerWidth < 768) {
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.className = 'fixed top-4 left-4 bg-white text-game-teal px-3 py-2 rounded hover:bg-gray-100 transition-colors z-50 md:hidden';
                fullscreenBtn.innerHTML = '‚õ∂';
                fullscreenBtn.title = 'Toggle Fullscreen';
                fullscreenBtn.onclick = toggleFullscreen;
                document.body.appendChild(fullscreenBtn);
            }
        }

        // Location sharing functionality
        function shareLocation() {
            if (!currentLocation) {
                alert('Location not available');
                return;
            }

            const shareData = {
                title: 'Aanchal Location Racing',
                text: `I'm racing at coordinates ${currentLocation.lat.toFixed(4)}, ${currentLocation.lng.toFixed(4)}! Join me in Location Racing!`,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData);
            } else {
                // Fallback for browsers without Web Share API
                const shareText = `${shareData.text}\n${shareData.url}`;
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Location shared to clipboard!');
                });
            }
        }

        // Add share button
        function addShareButton() {
            const shareBtn = document.createElement('button');
            shareBtn.className = 'fixed top-4 right-32 md:right-36 bg-white text-game-teal px-3 py-2 rounded hover:bg-gray-100 transition-colors z-50';
            shareBtn.innerHTML = 'üì§';
            shareBtn.title = 'Share Location';
            shareBtn.onclick = shareLocation;
            document.body.appendChild(shareBtn);
        }

        // Initialize all additional features
        document.addEventListener('DOMContentLoaded', function () {
            addSoundToggle();
            addFullscreenButton();
            addShareButton();
        });

        // Add offline support
        function checkOnlineStatus() {
            const statusIndicator = document.getElementById('onlineStatus');
            if (navigator.onLine) {
                statusIndicator.textContent = 'Online';
                statusIndicator.className = 'online-status online';
            } else {
                statusIndicator.textContent = 'Offline';
                statusIndicator.className = 'online-status offline';
            }
        }

        window.addEventListener('online', checkOnlineStatus);
        window.addEventListener('offline', checkOnlineStatus);

        // Service Worker registration for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js')
                    .then(function (registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function (err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Add performance monitoring
        function logPerformance() {
            if (performance.mark) {
                performance.mark('game-start');

                setTimeout(() => {
                    performance.mark('game-loaded');
                    performance.measure('game-load-time', 'game-start', 'game-loaded');

                    const measure = performance.getEntriesByName('game-load-time')[0];
                    console.log(`üöÄ Game loaded in ${measure.duration.toFixed(2)}ms`);
                }, 1000);
            }
        }

        // Battery API support
        function monitorBattery() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(function (battery) {
                    const batteryLevel = Math.round(battery.level * 100);
                    console.log(`üîã Battery level: ${batteryLevel}%`);

                    if (batteryLevel < 20) {
                        console.warn('‚ö†Ô∏è Low battery detected - consider reducing game performance');
                        // Reduce animation complexity for low battery
                        optimizeForMobile();
                    }
                });
            }
        }

        // Initialize performance monitoring
        logPerformance();
        monitorBattery();

        // Final initialization and console messages
        console.log('üèÅ Aanchal Location Racing - Game Loaded Successfully!');
        console.log('üìä Game Statistics:', gameData);
        console.log('üó∫Ô∏è Location Features:', locationEnabled ? 'Enabled' : 'Disabled');
        console.log('üéØ Press "S" key to view detailed stats');
        console.log('‚è∏Ô∏è Press SPACEBAR during game to pause');
        console.log('üîä Click sound button to toggle audio');
        console.log('üì± Mobile controls: 2x2 touch grid');
        console.log('üåê Online status monitoring enabled');

        // Easter egg - Konami code
        let konamiCode = [];
        const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight'];

        document.addEventListener('keydown', function (e) {
            konamiCode.push(e.key);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }

            if (konamiCode.join(',') === konamiSequence.join(',')) {
                console.log('üéÆ Konami Code activated! Extra features unlocked!');
                player.baseSpeed = 15;
                player.speed = 15;
                alert('üöÄ TURBO MODE ACTIVATED! Maximum speed unlocked!');
                konamiCode = [];
            }
        });

        // Add debug mode (press 'D' key)
        document.addEventListener('keydown', function (e) {
            if (e.key.toLowerCase() === 'd' && !gameStarted) {
                const debugInfo = document.createElement('div');
                debugInfo.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-90 text-white p-4 rounded-lg z-50 text-sm';
                debugInfo.innerHTML = `
                    <h3 class="font-bold mb-2">üîß Debug Information</h3>
                    <div class="space-y-1">
                        <p>Location Enabled: ${locationEnabled}</p>
                        <p>Current Location: ${currentLocation ? `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}` : 'None'}</p>
                        <p>Target Areas: ${targetAreas.length}</p>
                        <p>Game Started: ${gameStarted}</p>
                        <p>Sound Enabled: ${soundEnabled}</p>
                        <p>Screen Size: ${window.innerWidth}x${window.innerHeight}</p>
                        <p>User Agent: ${navigator.userAgent.substring(0, 50)}...</p>
                    </div>
                    <button onclick="this.parentElement.remove()" class="mt-2 bg-red-500 text-white px-2 py-1 rounded text-xs">Close</button>
                `;
                document.body.appendChild(debugInfo);

                setTimeout(() => {
                    if (debugInfo.parentNode) {
                        debugInfo.remove();
                    }
                }, 10000);
            }
        });

        // Add achievement system
        const achievements = {
            firstTarget: { unlocked: false, name: "First Target", description: "Collect your first target" },
            speedDemon: { unlocked: false, name: "Speed Demon", description: "Reach 200 kmph" },
            survivor: { unlocked: false, name: "Survivor", description: "Survive for 60 seconds" },
            collector: { unlocked: false, name: "Collector", description: "Collect 10 targets in one game" },
            explorer: { unlocked: false, name: "Explorer", description: "Travel 1000m in one game" }
        };

        function checkAchievements() {
            // Check first target
            if (!achievements.firstTarget.unlocked && currentTargetsCollected >= 1) {
                unlockAchievement('firstTarget');
            }

            // Check speed demon
            if (!achievements.speedDemon.unlocked && player.kmph >= 200) {
                unlockAchievement('speedDemon');
            }

            // Check collector
            if (!achievements.collector.unlocked && currentTargetsCollected >= 10) {
                unlockAchievement('collector');
            }

            // Check explorer
            if (!achievements.explorer.unlocked && currentDistanceTraveled >= 1000) {
                unlockAchievement('explorer');
            }
        }

        function unlockAchievement(achievementKey) {
            const achievement = achievements[achievementKey];
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;

                // Show achievement notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-1/4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black p-4 rounded-lg z-50 animate-bounce-in';
                notification.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-2">üèÜ</div>
                        <div class="font-bold">Achievement Unlocked!</div>
                        <div class="text-sm">${achievement.name}</div>
                        <div class="text-xs mt-1">${achievement.description}</div>
                    </div>
                `;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);

                // Save achievement
                localStorage.setItem('locationRaceAchievements', JSON.stringify(achievements));
            }
        }

        // Load saved achievements
        const savedAchievements = localStorage.getItem('locationRaceAchievements');
        if (savedAchievements) {
            Object.assign(achievements, JSON.parse(savedAchievements));
        }

        // Add achievement checking to game loop
        const originalUpdateLevel = updateLevel;
        updateLevel = function () {
            originalUpdateLevel();
            checkAchievements();
        };

        // Add weather integration (if available)
        function getWeatherInfo() {
            if (currentLocation && navigator.onLine) {
                // This would integrate with a weather API
                // For demo purposes, we'll simulate weather effects
                const weatherConditions = ['sunny', 'rainy', 'cloudy', 'foggy'];
                const currentWeather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];

                console.log(`üå§Ô∏è Current weather: ${currentWeather}`);

                // Apply weather effects to game
                applyWeatherEffects(currentWeather);
            }
        }

        function applyWeatherEffects(weather) {
            const gameArea = document.querySelector('.GameArea');
            if (!gameArea) return;

            // Remove existing weather classes
            gameArea.classList.remove('weather-sunny', 'weather-rainy', 'weather-cloudy', 'weather-foggy');

            // Apply new weather effect
            gameArea.classList.add(`weather-${weather}`);

            // Adjust game mechanics based on weather
            switch (weather) {
                case 'rainy':
                    player.baseSpeed = Math.max(player.baseSpeed * 0.8, 3); // Reduce speed in rain
                    break;
                case 'foggy':
                    // Reduce visibility (could add CSS effects)
                    break;
                case 'sunny':
                    // Bonus speed in good weather
                    player.baseSpeed = Math.min(player.baseSpeed * 1.1, 15);
                    break;
            }
        }

        // Initialize weather on gamestart
        const originalStartGame = startGame;
        startGame = function () {
            originalStartGame();
            getWeatherInfo();
        };

        // Add time-based challenges
        function initializeTimeBasedChallenges() {
            const currentHour = new Date().getHours();
            let challengeMessage = '';
            let challengeMultiplier = 1;

            if (currentHour >= 6 && currentHour < 12) {
                challengeMessage = 'üåÖ Morning Rush: +20% points!';
                challengeMultiplier = 1.2;
            } else if (currentHour >= 12 && currentHour < 18) {
                challengeMessage = '‚òÄÔ∏è Afternoon Drive: Normal scoring';
                challengeMultiplier = 1.0;
            } else if (currentHour >= 18 && currentHour < 22) {
                challengeMessage = 'üåÜ Evening Traffic: +10% points, more obstacles!';
                challengeMultiplier = 1.1;
            } else {
                challengeMessage = 'üåô Night Mode: +50% points, reduced visibility!';
                challengeMultiplier = 1.5;
            }

            console.log(`‚è∞ ${challengeMessage}`);

            // Apply challenge effects
            const originalScore = player.score;
            player.scoreMultiplier = challengeMultiplier;

            // Show challenge notification
            if (challengeMultiplier !== 1.0) {
                const challengeNotification = document.createElement('div');
                challengeNotification.className = 'fixed top-32 left-1/2 transform -translate-x-1/2 bg-purple-600 text-white p-3 rounded-lg z-40 text-sm';
                challengeNotification.textContent = challengeMessage;
                document.body.appendChild(challengeNotification);

                setTimeout(() => {
                    challengeNotification.remove();
                }, 5000);
            }
        }

        // Add leaderboard functionality
        function updateLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('locationRaceLeaderboard') || '[]');

            if (player.score > 0) {
                const entry = {
                    score: player.score,
                    level: currentLevel,
                    targets: currentTargetsCollected,
                    distance: currentDistanceTraveled,
                    timestamp: new Date().toISOString(),
                    location: currentLocation ? `${currentLocation.lat.toFixed(4)}, ${currentLocation.lng.toFixed(4)}` : 'Unknown'
                };

                leaderboard.push(entry);
                leaderboard.sort((a, b) => b.score - a.score);
                leaderboard.splice(10); // Keep only top 10

                localStorage.setItem('locationRaceLeaderboard', JSON.stringify(leaderboard));
            }

            return leaderboard;
        }

        function showLeaderboard() {
            const leaderboard = updateLeaderboard();
            const leaderboardDiv = document.createElement('div');
            leaderboardDiv.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4';

            let leaderboardHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-96 overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-4 text-center">üèÜ Leaderboard</h2>
                    <div class="space-y-2">
            `;

            if (leaderboard.length === 0) {
                leaderboardHTML += '<p class="text-center text-gray-500">No scores yet!</p>';
            } else {
                leaderboard.forEach((entry, index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                    const date = new Date(entry.timestamp).toLocaleDateString();

                    leaderboardHTML += `
                        <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
                            <div>
                                <span class="font-bold">${medal}</span>
                                <span class="ml-2">${entry.score} pts</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                L${entry.level} ‚Ä¢ ${entry.targets}üéØ ‚Ä¢ ${date}
                            </div>
                        </div>
                    `;
                });
            }

            leaderboardHTML += `
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-4 bg-game-teal text-white py-2 rounded hover:bg-opacity-90">
                        Close
                    </button>
                </div>
            `;

            leaderboardDiv.innerHTML = leaderboardHTML;
            document.body.appendChild(leaderboardDiv);
        }

        // Add leaderboard button
        function addLeaderboardButton() {
            const leaderboardBtn = document.createElement('button');
            leaderboardBtn.className = 'fixed top-4 right-44 md:right-48 bg-white text-game-teal px-3 py-2 rounded hover:bg-gray-100 transition-colors z-50';
            leaderboardBtn.innerHTML = 'üèÜ';
            leaderboardBtn.title = 'View Leaderboard';
            leaderboardBtn.onclick = showLeaderboard;
            document.body.appendChild(leaderboardBtn);
        }

        // Add social features
        function generateShareableScore() {
            const shareText = `üèÅ Just scored ${player.score} points in Aanchal Location Racing! 
üéØ Collected ${currentTargetsCollected} targets
üìè Traveled ${currentDistanceTraveled}m
üèÜ Reached level ${currentLevel}

Can you beat my score? Play now!`;

            if (navigator.share) {
                navigator.share({
                    title: 'Aanchal Location Racing Score',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText + '\n' + window.location.href).then(() => {
                    alert('Score shared to clipboard!');
                });
            }
        }

        // Add share score button to game over screen
        const originalEndGame = endGame;
        endGame = function (collidedEnemyCar) {
            originalEndGame(collidedEnemyCar);
            updateLeaderboard();

            // Add share button to game over screen
            setTimeout(() => {
                const gameOverScreen = document.getElementById('gameOverScreen');
                if (gameOverScreen && !gameOverScreen.querySelector('.share-score-btn')) {
                    const shareBtn = document.createElement('button');
                    shareBtn.className = 'share-score-btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors mt-2';
                    shareBtn.textContent = 'üì§ Share Score';
                    shareBtn.onclick = generateShareableScore;

                    const buttonContainer = gameOverScreen.querySelector('.flex');
                    if (buttonContainer) {
                        buttonContainer.appendChild(shareBtn);
                    }
                }
            }, 1100);
        };

        // Add progressive web app features
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button
            const installBtn = document.createElement('button');
            installBtn.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-600 transition-colors z-50';
            installBtn.innerHTML = 'üì± Install App';
            installBtn.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                });
            };
            document.body.appendChild(installBtn);

            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (installBtn.parentNode) {
                    installBtn.remove();
                }
            }, 10000);
        });

        // Add haptic feedback for mobile
        function vibrate(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        // Add vibration to game events
        const originalPlayCollisionSoundWithVibration = playCollisionSound;
        playCollisionSound = function () {
            if (soundEnabled) originalPlayCollisionSoundWithVibration();
            vibrate([200, 100, 200]); // Collision vibration pattern
        };

        const originalPlayTargetReachedSoundWithVibration = playTargetReachedSound;
        playTargetReachedSound = function () {
            if (soundEnabled) originalPlayTargetReachedSoundWithVibration();
            vibrate(100); // Target collected vibration
        };

        // Add network status monitoring
        function updateNetworkStatus() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                const networkInfo = document.getElementById('networkInfo');
                if (networkInfo) {
                    networkInfo.textContent = `${connection.effectiveType.toUpperCase()} ‚Ä¢ ${Math.round(connection.downlink)}Mbps`;
                }

                // Adjust game quality based on connection
                if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                    console.log('üì∂ Slow connection detected - optimizing performance');
                    optimizeForMobile();
                }
            }
        }

        if (navigator.connection) {
            navigator.connection.addEventListener('change', updateNetworkStatus);
            updateNetworkStatus();
        }

        // Add accessibility features
        function initializeAccessibility() {
            // High contrast mode
            if (window.matchMedia && window.matchMedia('(prefers-contrast: high)').matches) {
                document.body.classList.add('high-contrast');
            }

            // Reduced motion
            if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.body.classList.add('reduced-motion');
                console.log('‚ôø Reduced motion preferences detected');
            }

            // Add keyboard navigation hints
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Tab') {
                    document.body.classList.add('keyboard-navigation');
                }
            });

            document.addEventListener('mousedown', function () {
                document.body.classList.remove('keyboard-navigation');
            });
        }

        // Initialize all new features
        document.addEventListener('DOMContentLoaded', function () {
            addLeaderboardButton();
            initializeTimeBasedChallenges();
            initializeAccessibility();
            checkOnlineStatus();
        });

        // Add game analytics (privacy-friendly)
        function logGameEvent(event, data = {}) {
            const gameEvent = {
                event: event,
                timestamp: new Date().toISOString(),
                data: data,
                sessionId: sessionStorage.getItem('gameSessionId') || Date.now().toString()
            };

            // Store locally (no external tracking)
            const events = JSON.parse(localStorage.getItem('gameEvents') || '[]');
            events.push(gameEvent);

            // Keep only last 100 events
            if (events.length > 100) {
                events.splice(0, events.length - 100);
            }

            localStorage.setItem('gameEvents', JSON.stringify(events));
            console.log(`üìä Event logged: ${event}`, data);
        }

        // Set session ID
        if (!sessionStorage.getItem('gameSessionId')) {
            sessionStorage.setItem('gameSessionId', Date.now().toString());
        }

        // Log key game events
        const originalStartGameWithAnalytics = startGame;
        startGame = function () {
            originalStartGameWithAnalytics();
            logGameEvent('game_started', {
                locationEnabled: locationEnabled,
                soundEnabled: soundEnabled
            });
        };

        const originalEndGameWithAnalytics = endGame;
        endGame = function (collidedEnemyCar) {
            logGameEvent('game_ended', {
                score: player.score,
                level: currentLevel,
                targets: currentTargetsCollected,
                distance: currentDistanceTraveled,
                duration: Date.now() - parseInt(sessionStorage.getItem('gameStartTime') || '0')
            });
            originalEndGameWithAnalytics(collidedEnemyCar);
        };

        // Add game tips system
        const gameTips = [
            "üí° Use the up arrow to accelerate and gain more points!",
            "üéØ Collect targets to boost your score significantly!",
            "üìç Enable location services for the full GPS racing experience!",
            "üîä Turn on sound for better gameplay feedback!",
            "‚è∏Ô∏è Press SPACEBAR to pause the game anytime!",
            "üåô Play at night for bonus points!",
            "üèÜ Check the leaderboard to see your best scores!",
            "üì± Install the app for offline play!",
            "üéÆ Try the Konami code for a surprise!",
            "‚ôø The game supports accessibility features!"
        ];

        function showRandomTip() {
            const tip = gameTips[Math.floor(Math.random() * gameTips.length)];
            const tipDiv = document.createElement('div');
            tipDiv.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white p-3 rounded-lg z-40 text-sm max-w-xs text-center';
            tipDiv.textContent = tip;
            document.body.appendChild(tipDiv);

            setTimeout(() => {
                tipDiv.remove();
            }, 4000);
        }

        // Show tip periodically
        setInterval(() => {
            if (!gameStarted && Math.random() < 0.3) {
                showRandomTip();
            }
        }, 30000);

        // Add final console summary
        setTimeout(() => {
            console.log(`
üéÆ AANCHAL LOCATION RACING - FULLY LOADED!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä FEATURES ENABLED:
‚Ä¢ GPS Location Racing ‚úì
‚Ä¢ Real-time Target Collection ‚úì
‚Ä¢ Interactive Map Integration ‚úì
‚Ä¢ Mobile Touch Controls (2x2 Grid) ‚úì
‚Ä¢ Sound & Vibration Feedback ‚úì
‚Ä¢ Achievement System ‚úì
‚Ä¢ Leaderboard & Social Sharing ‚úì
‚Ä¢ Progressive Web App Support ‚úì
‚Ä¢ Offline Capabilities ‚úì
‚Ä¢ Accessibility Features ‚úì
‚Ä¢ Weather Effects ‚úì
‚Ä¢ Time-based Challenges ‚úì
‚Ä¢ Performance Monitoring ‚úì

üéØ GAME STATISTICS:
‚Ä¢ High Score: ${gameData.highScore}
‚Ä¢ Total Games: ${gameData.totalGames}
‚Ä¢ Targets Reached: ${gameData.targetsReached}
‚Ä¢Distance Traveled: ${gameData.totalDistance}m

üó∫Ô∏è LOCATION STATUS: ${locationEnabled ? 'ENABLED' : 'DISABLED'}
üì± DEVICE: ${window.innerWidth < 768 ? 'MOBILE' : 'DESKTOP'}
üåê CONNECTION: ${navigator.onLine ? 'ONLINE' : 'OFFLINE'}

üéÆ CONTROLS:
‚Ä¢ Arrow Keys: Move car
‚Ä¢ SPACEBAR: Pause/Resume
‚Ä¢ S Key: Show statistics
‚Ä¢ D Key: Debug information

üèÜ ACHIEVEMENTS UNLOCKED: ${Object.values(achievements).filter(a => a.unlocked).length}/${Object.keys(achievements).length}

Ready to race! üèÅ
            `);
        }, 2000);

        // Add error boundary for better error handling
        window.addEventListener('unhandledrejection', function (event) {
            console.error('Unhandled promise rejection:', event.reason);
            logGameEvent('error', {
                type: 'unhandled_rejection',
                message: event.reason?.message || 'Unknown error'
            });
        });

        // Add memory usage monitoring
        function monitorMemoryUsage() {
            if (performance.memory) {
                const memoryInfo = {
                    used: Math.round(performance.memory.usedJSHeapSize / 1048576),
                    total: Math.round(performance.memory.totalJSHeapSize / 1048576),
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576)
                };

                console.log(`üíæ Memory: ${memoryInfo.used}MB / ${memoryInfo.total}MB (Limit: ${memoryInfo.limit}MB)`);

                // Warn if memory usage is high
                if (memoryInfo.used > memoryInfo.limit * 0.8) {
                    console.warn('‚ö†Ô∏è High memory usage detected - consider refreshing the page');
                }
            }
        }

        // Monitor memory every 30 seconds during gameplay
        setInterval(() => {
            if (gameStarted) {
                monitorMemoryUsage();
            }
        }, 30000);

        // Add game state persistence
        function saveGameState() {
            if (gameStarted && !gameover) {
                const gameState = {
                    player: player,
                    currentLevel: currentLevel,
                    currentTargetsCollected: currentTargetsCollected,
                    currentDistanceTraveled: currentDistanceTraveled,
                    timestamp: Date.now()
                };
                sessionStorage.setItem('gameState', JSON.stringify(gameState));
            }
        }

        function loadGameState() {
            const savedState = sessionStorage.getItem('gameState');
            if (savedState) {
                const gameState = JSON.parse(savedState);
                const timeDiff = Date.now() - gameState.timestamp;

                // Only restore if saved within last 5 minutes
                if (timeDiff < 300000) {
                    const restoreBtn = document.createElement('button');
                    restoreBtn.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-yellow-500 text-black px-6 py-3 rounded-lg z-50 font-bold';
                    restoreBtn.innerHTML = 'üîÑ Restore Previous Game?<br><span class="text-sm">Score: ' + gameState.player.score + '</span>';
                    restoreBtn.onclick = () => {
                        player = gameState.player;
                        currentLevel = gameState.currentLevel;
                        currentTargetsCollected = gameState.currentTargetsCollected;
                        currentDistanceTraveled = gameState.currentDistanceTraveled;

                        // Update displays
                        score.textContent = player.score;
                        level.textContent = currentLevel;
                        targetsCollected.textContent = currentTargetsCollected;

                        restoreBtn.remove();
                        startGameCountdown();
                    };

                    document.body.appendChild(restoreBtn);

                    // Auto-remove after 10 seconds
                    setTimeout(() => {
                        if (restoreBtn.parentNode) {
                            restoreBtn.remove();
                        }
                    }, 10000);
                }
            }
        }

        // Save game state periodically
        setInterval(saveGameState, 5000);

        // Load game state on page load
        setTimeout(loadGameState, 1000);

        // Clear game state on normal game end
        const originalEndGameWithStateCleanup = endGame;
        endGame = function (collidedEnemyCar) {
            sessionStorage.removeItem('gameState');
            originalEndGameWithStateCleanup(collidedEnemyCar);
        };

        // Add theme system
        const themes = {
            default: {
                name: 'Default',
                colors: {
                    primary: '#008080',
                    secondary: '#ff6347',
                    success: '#22c55e',
                    danger: '#ef4444'
                }
            },
            dark: {
                name: 'Dark Mode',
                colors: {
                    primary: '#1f2937',
                    secondary: '#f59e0b',
                    success: '#10b981',
                    danger: '#f87171'
                }
            },
            neon: {
                name: 'Neon',
                colors: {
                    primary: '#8b5cf6',
                    secondary: '#06ffa5',
                    success: '#00ff88',
                    danger: '#ff0080'
                }
            }
        };

        let currentTheme = localStorage.getItem('gameTheme') || 'default';

        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;

            const root = document.documentElement;
            root.style.setProperty('--color-primary', theme.colors.primary);
            root.style.setProperty('--color-secondary', theme.colors.secondary);
            root.style.setProperty('--color-success', theme.colors.success);
            root.style.setProperty('--color-danger', theme.colors.danger);

            currentTheme = themeName;
            localStorage.setItem('gameTheme', themeName);

            console.log(`üé® Theme changed to: ${theme.name}`);
        }

        function cycleTheme() {
            const themeKeys = Object.keys(themes);
            const currentIndex = themeKeys.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themeKeys.length;
            applyTheme(themeKeys[nextIndex]);
        }

        // Add theme toggle button
        function addThemeToggle() {
            const themeBtn = document.createElement('button');
            themeBtn.className = 'fixed top-4 right-56 md:right-60 bg-white text-game-teal px-3 py-2 rounded hover:bg-gray-100 transition-colors z-50';
            themeBtn.innerHTML = 'üé®';
            themeBtn.title = 'Change Theme';
            themeBtn.onclick = cycleTheme;
            document.body.appendChild(themeBtn);
        }

        // Apply saved theme on load
        applyTheme(currentTheme);

        // Add screenshot functionality
        function takeScreenshot() {
            html2canvas(document.body).then(canvas => {
                const link = document.createElement('a');
                link.download = `aanchal-racing-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                console.error('Screenshot failed:', err);
                // Fallback: copy game stats to clipboard
                const stats = `üèÅ Aanchal Location Racing
Score: ${player.score}
Level: ${currentLevel}
Targets: ${currentTargetsCollected}
Distance: ${currentDistanceTraveled}m`;
                navigator.clipboard.writeText(stats);
                alert('Screenshot not available, stats copied to clipboard!');
            });
        }

        // Add screenshot button (only if html2canvas is available)
        function addScreenshotButton() {
            if (typeof html2canvas !== 'undefined') {
                const screenshotBtn = document.createElement('button');
                screenshotBtn.className = 'fixed top-4 right-68 md:right-72 bg-white text-game-teal px-3 py-2 rounded hover:bg-gray-100 transition-colors z-50';
                screenshotBtn.innerHTML = 'üì∏';
                screenshotBtn.title = 'Take Screenshot';
                screenshotBtn.onclick = takeScreenshot;
                document.body.appendChild(screenshotBtn);
            }
        }

        // Initialize all final features
        document.addEventListener('DOMContentLoaded', function () {
            addThemeToggle();
            addScreenshotButton();
        });

        // Add final game ready state
        let gameFullyLoaded = false;

        function markGameAsReady() {
            gameFullyLoaded = true;
            document.body.classList.add('game-ready');

            // Dispatch custom event
            const gameReadyEvent = new CustomEvent('gameReady', {
                detail: {
                    version: '2.0.0',
                    features: Object.keys({
                        locationRacing: locationEnabled,
                        soundSystem: soundEnabled,
                        achievements: true,
                        leaderboard: true,
                        themes: true,
                        accessibility: true,
                        pwa: true
                    }).length,
                    loadTime: performance.now()
                }
            });

            window.dispatchEvent(gameReadyEvent);
            console.log('üéÆ Game fully loaded and ready!');
        }

        // Mark game as ready after all initialization
        setTimeout(markGameAsReady, 3000);

        // Add version info
        const gameVersion = {
            version: '2.0.0',
            codename: 'Location Racer',
            buildDate: new Date().toISOString(),
            features: [
                'GPS Location Integration',
                'Real-time Target Collection',
                'Interactive Maps',
                'Mobile Touch Controls',
                'Achievement System',
                'Leaderboard',
                'Theme System',
                'PWA Support',
                'Accessibility Features',
                'Weather Effects',
                'Social Sharing',
                'Offline Support'
            ]
        };

        console.log('üìã Game Version Info:', gameVersion);

        // Export game API for external use
        window.AanchalLocationRacing = {
            version: gameVersion.version,
            startGame: startGame,
            pauseGame: togglePause,
            getStats: () => gameData,
            getAchievements: () => achievements,
            changeTheme: applyTheme,
            takeScreenshot: takeScreenshot,
            showLeaderboard: showLeaderboard,
            enableLocation: enableLocation,
            isReady: () => gameFullyLoaded
        };

        // Final success message
        console.log(`
üèÅ AANCHAL LOCATION RACING v${gameVersion.version} - READY TO RACE!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üéÆ Game API available at: window.AanchalLocationRacing
üì± Mobile optimized with touch controls
üó∫Ô∏è GPS location features ${locationEnabled ? 'ENABLED' : 'available'}
üèÜ Achievement system with ${Object.keys(achievements).length} achievements
üé® ${Object.keys(themes).length} themes available
‚ôø Accessibility features enabled

Start your engines! üöóüí®
        `);

    </script>
</body>

</html>